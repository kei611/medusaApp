name: CD Pipeline to EC2 (No CI Phase)

on:
  push:
    branches:
      - main # main ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã§ãƒˆãƒªã‚¬ãƒ¼

env:
  # ç’°å¢ƒå¤‰æ•° (GitHub Secrets ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨)
  EC2_HOST: ${{ secrets.EC2_HOST }} # EC2ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã¾ãŸã¯DNSå
  EC2_USER: ec2-user # EC2ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å (ä¾‹: Amazon Linuxã¯ec2-user)
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }} # EC2æ¥ç¶šç”¨ã®SSHç§˜å¯†éµ

  # Medusa Backend ã®ç’°å¢ƒå¤‰æ•° (EC2ä¸Šã®.envã«æ›¸ãè¾¼ã‚€ç”¨)
  DB_URL: ${{ secrets.DATABASE_URL }}
  RD_URL: ${{ secrets.REDIS_URL }}
  STORE_CORS_ORIGINS: ${{ secrets.STORE_CORS }}
  ADMIN_CORS_ORIGINS: ${{ secrets.ADMIN_CORS }}
  AUTH_CORS_ORIGINS: ${{ secrets.AUTH_CORS }}
  S3_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
  S3_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
  S3_BASE: ${{ secrets.S3_BASE_URL }}
  JWT: ${{ secrets.JWT_SECRET }}
  COOKIE: ${{ secrets.COOKIE_SECRET }}
  # ... ãã®ä»–å¿…è¦ãªMedusaç’°å¢ƒå¤‰æ•°
  # Next.js ã‚¹ãƒˆã‚¢ãƒ•ãƒ­ãƒ³ãƒˆã®ç’°å¢ƒå¤‰æ•° (EC2ä¸Šã®.envã«æ›¸ãè¾¼ã‚€ç”¨)
  MEDUSA_BACKEND_URL: ${{ secrets.MEDUSA_BACKEND_URL }}
  NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY }}
  NEXT_PUBLIC_BASE_URL: ${{ secrets.NEXT_PUBLIC_BASE_URL }}
  NEXT_PUBLIC_DEFAULT_REGION: ${{ secrets.NEXT_PUBLIC_DEFAULT_REGION }}
  NEXT_PUBLIC_STRIPE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_KEY }}
  REVALIDATE_SECRET: ${{ secrets.REVALIDATE_SECRET }}
  NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
  NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
  NEXT_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
  # ... ãã®ä»–å¿…è¦ãªNext.jsç’°å¢ƒå¤‰æ•°

# ... çœç•¥ã•ã‚ŒãŸå†’é ­éƒ¨åˆ†ã¯å¤‰æ›´ãªã— ...

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          script: |
            PROJECT_DIR="/home/${{ env.EC2_USER }}/medusaApp"
            cd ${PROJECT_DIR}

            echo "ğŸ“¦ Pulling latest code..."
            git pull origin main

            # .env for Medusa Backend
            echo "âš™ï¸ Writing .env for Medusa Backend..."
            cat << EOF > ./my-store/.env
            NODE_ENV=development
            DATABASE_URL=${{ env.DB_URL }}
            REDIS_URL=${{ env.RD_URL }}
            STORE_CORS=${{ env.STORE_CORS_ORIGINS }}
            ADMIN_CORS=${{ env.ADMIN_CORS_ORIGINS }}
            AUTH_CORS=${{ env.AUTH_CORS_ORIGINS }}
            JWT_SECRET=${{ env.JWT }}
            COOKIE_SECRET=${{ env.COOKIE }}
            S3_ACCESS_KEY_ID=${{ env.S3_ID }}
            S3_SECRET_ACCESS_KEY=${{ env.S3_KEY }}
            S3_BASE_URL=${{ env.S3_BASE }}
            FRONTEND_URL=${{ env.NEXT_APP_URL }}
            NEXT_PUBLIC_MEDUSA_BACKEND_URL=${{ env.MEDUSA_BACKEND_URL }}
            NEXT_PUBLIC_APP_URL=${{ env.NEXT_APP_URL }}
            EOF

            echo "âœ… .env created"

            # Medusa Backend: Build & Run
            echo "ğŸš€ Deploying Medusa Backend..."
            cd my-store
            npm install
            npm run build
            npm run migrate
            pm2 delete medusa-backend || true
            pm2 start --name medusa-backend npm -- start
            pm2 save
            cd ..

            # .env.local for Storefront
            echo "âš™ï¸ Writing .env.local for Storefront..."
            cat << EOF > ./my-store-storefront/.env.local
            MEDUSA_BACKEND_URL=${{ env.MEDUSA_BACKEND_URL }}
            NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY=${{ env.NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY }}
            NEXT_PUBLIC_BASE_URL=${{ env.NEXT_PUBLIC_BASE_URL }}
            NEXT_PUBLIC_DEFAULT_REGION=${{ env.NEXT_PUBLIC_DEFAULT_REGION }}
            NEXT_PUBLIC_STRIPE_KEY=${{ env.NEXT_PUBLIC_STRIPE_KEY }}
            REVALIDATE_SECRET=${{ env.REVALIDATE_SECRET }}
            NEXT_PUBLIC_SANITY_PROJECT_ID=${{ env.NEXT_PUBLIC_SANITY_PROJECT_ID }}
            NEXT_PUBLIC_SANITY_DATASET=${{ env.NEXT_PUBLIC_SANITY_DATASET }}
            EOF

            echo "âœ… .env.local created"

            # Storefront: Build & PM2 Run with cwd
            echo "ğŸš€ Deploying Next.js Storefront..."
            cd my-store-storefront
            npm install --production=false
            npm run build
            pm2 delete medusa-storefront || true
            pm2 start npm --name "medusa-storefront" --cwd ./my-store-storefront -- start
            pm2 save

            echo "ğŸ‰ Deployment finished!"
